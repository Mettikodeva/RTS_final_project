#include <DHTesp.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <WiFi.h>
#include <Wire.h>
#include <driver/gpio.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>

// Pin Definitions
#define DHTPIN 14        // Pin connected to DHT sensor
#define DHTTYPE DHTesp::DHT22 // DHT sensor type
#define BUTTON_PIN 12    // Pin connected to the button
#define RED_LED_PIN 4    // Pin connected to the red LED
#define GREEN_LED_PIN 15 // Pin connected to the green LED

#define NTP_SERVER "pool.ntp.org"
#define UTC_OFFSET 7
#define UTC_OFFSET_DST 0

// OLED display configuration
Adafruit_SSD1306 display(128, 64, &Wire, -1);

// DHT sensor instance
DHTesp dht;

// Task handles
TaskHandle_t temperatureTaskHandle;
TaskHandle_t displayTaskHandle;

// Semaphore for button press
SemaphoreHandle_t buttonSemaphore;

// LED states
bool redLedState = false;
bool greenLedState = false;

// WIFI
const char *ssid = "Wokwi-GUEST";
const char *password = "";

// Display modes
enum DisplayMode
{
    DISPLAY_MODE_TEMP_HUM,
    DISPLAY_MODE_CLOCK
};

DisplayMode currentDisplayMode = DISPLAY_MODE_TEMP_HUM;

// Global variables
TempAndHumidity data ;
int time_to_display_clock = 3;

// #define LOGO_HEIGHT 16
// #define LOGO_WIDTH 16
// 'download2', 128x64px
const unsigned char bitmap[] PROGMEM = {
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x57, 0x75, 0x55, 0x55, 0x55, 0x51, 0x51, 0x15, 0x51, 0x55,
    0xa0, 0x02, 0x22, 0x22, 0x22, 0x02, 0xff, 0xff, 0xa0, 0x20, 0x22, 0x20, 0x20, 0x02, 0x02, 0x22,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x01, 0xff, 0xff, 0xd4, 0x15, 0x55, 0x55, 0x54, 0x55, 0x55, 0x55,
    0xae, 0x80, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x08, 0x00, 0x80, 0x08, 0x00, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x55, 0x54, 0x01, 0x7f, 0xff, 0xf4, 0x15, 0x55, 0x51, 0x55, 0x15, 0x51, 0x55,
    0xbb, 0xba, 0x02, 0x22, 0x00, 0x03, 0xff, 0xff, 0xf8, 0x02, 0x02, 0x20, 0x20, 0x00, 0x02, 0x20,
    0x55, 0x55, 0x55, 0x55, 0x54, 0x05, 0xff, 0xff, 0xfc, 0x05, 0x55, 0x55, 0x54, 0x55, 0x55, 0x55,
    0xaf, 0xeb, 0x80, 0x00, 0x00, 0x03, 0xff, 0xff, 0xfe, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x55, 0x54, 0x17, 0xff, 0xff, 0xff, 0x11, 0x55, 0x51, 0x55, 0x15, 0x11, 0x55,
    0x22, 0xbb, 0xa2, 0x20, 0x00, 0x07, 0xff, 0xff, 0xff, 0x00, 0x02, 0x00, 0x20, 0x00, 0x00, 0x20,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x5f, 0xff, 0xff, 0xff, 0x55, 0x55, 0x55, 0x54, 0x55, 0x45, 0x54,
    0x00, 0x08, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xa0, 0x0a, 0x80, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x51, 0x15, 0x55, 0x57, 0x77, 0x77, 0xf5, 0x77, 0x55, 0x15, 0x51, 0x55, 0x15, 0x11, 0x55,
    0x00, 0x00, 0x02, 0x22, 0x23, 0xff, 0xe3, 0xfe, 0xff, 0xf0, 0x02, 0x80, 0x20, 0x00, 0x00, 0x20,
    0x05, 0x44, 0x55, 0x55, 0x55, 0xff, 0xc5, 0xfc, 0x5f, 0xd5, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54,
    0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x83, 0xf8, 0x7f, 0xf8, 0x00, 0x00, 0x08, 0x00, 0x80, 0x00,
    0x01, 0x11, 0x15, 0x55, 0x57, 0x77, 0x17, 0xf5, 0x77, 0x71, 0x15, 0x51, 0x55, 0x11, 0x11, 0x51,
    0x00, 0x00, 0x02, 0x22, 0x2f, 0xff, 0x07, 0xfa, 0x3f, 0xf8, 0x00, 0x20, 0x20, 0x00, 0x00, 0x00,
    0x50, 0x05, 0x55, 0x55, 0x5d, 0xdd, 0x57, 0xfc, 0x1d, 0xd5, 0x55, 0x44, 0x54, 0x55, 0x45, 0x50,
    0x80, 0x00, 0x00, 0x00, 0x1f, 0xff, 0x1f, 0xfe, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x55, 0x51, 0x55, 0x55, 0x57, 0x75, 0x17, 0x77, 0x17, 0x75, 0x15, 0x51, 0x55, 0x11, 0x11, 0x51,
    0xbb, 0x22, 0x22, 0x22, 0x3f, 0xff, 0xbf, 0xff, 0xaf, 0xfe, 0x02, 0x00, 0x20, 0x00, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x55, 0x5d, 0x55, 0x5f, 0xdd, 0xd5, 0x5d, 0x55, 0x44, 0x54, 0x15, 0x45, 0x55,
    0x2a, 0xb8, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a,
    0x55, 0x55, 0x55, 0x55, 0x15, 0x55, 0x75, 0x17, 0x75, 0x75, 0x15, 0x51, 0x15, 0x11, 0x11, 0x55,
    0x02, 0xa2, 0x22, 0x22, 0x00, 0xfb, 0xb8, 0x0f, 0xfb, 0xf8, 0x02, 0x00, 0x20, 0x00, 0x00, 0x02,
    0x55, 0x45, 0x55, 0x54, 0x00, 0x55, 0x55, 0x55, 0x55, 0x54, 0x05, 0x44, 0x54, 0x15, 0x45, 0x45,
    0x0b, 0x80, 0x00, 0x80, 0x00, 0x3e, 0xa2, 0x8a, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
    0x15, 0x05, 0x55, 0x55, 0x00, 0x15, 0x55, 0x15, 0x55, 0x50, 0x05, 0x51, 0x15, 0x11, 0x11, 0x55,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xa2, 0x0a, 0x3b, 0xa0, 0x00, 0x00, 0x20, 0x00, 0x00, 0x2a,
    0x00, 0x15, 0x55, 0x54, 0x00, 0x05, 0x55, 0x55, 0x55, 0x40, 0x01, 0x40, 0x54, 0x04, 0x41, 0x55,
    0x80, 0x2a, 0xaa, 0xa8, 0x00, 0x00, 0x00, 0x0a, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38,
    0x50, 0x55, 0x55, 0x50, 0x00, 0x00, 0x11, 0x15, 0x55, 0x00, 0x01, 0x51, 0x15, 0x11, 0x11, 0x75,
    0x20, 0x22, 0x2a, 0x20, 0x00, 0x00, 0x00, 0x02, 0x20, 0x00, 0x00, 0x00, 0x00, 0x22, 0x02, 0x32,
    0x55, 0x55, 0x55, 0x50, 0x00, 0x00, 0x05, 0x45, 0x40, 0x00, 0x00, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x0a, 0xaf, 0xab, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x02, 0xa8, 0x00, 0x80,
    0x55, 0x55, 0x17, 0x51, 0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x00, 0x15, 0x55, 0x55, 0x55, 0x01,
    0xab, 0xa3, 0x3e, 0x80, 0x00, 0x00, 0x00, 0x20, 0x20, 0x00, 0x00, 0x02, 0x22, 0xba, 0xa0, 0x00,
    0x55, 0x55, 0x55, 0x40, 0x00, 0x00, 0x00, 0x55, 0x55, 0x00, 0x00, 0x15, 0x55, 0x55, 0x54, 0x00,
    0xee, 0xee, 0xae, 0x80, 0x00, 0x00, 0x00, 0x2a, 0xa8, 0xe0, 0x00, 0x0a, 0x8a, 0xa8, 0xa8, 0x00,
    0x55, 0x55, 0x55, 0x10, 0x00, 0x00, 0x00, 0x55, 0x55, 0x50, 0x00, 0x15, 0x55, 0x55, 0x71, 0x01,
    0xbb, 0xbb, 0xba, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfa, 0x60, 0x00, 0x02, 0xa2, 0x23, 0xa0, 0x00,
    0x55, 0x55, 0x55, 0x40, 0x00, 0x00, 0x00, 0x55, 0x55, 0x70, 0x00, 0x05, 0x55, 0x55, 0x54, 0x00,
    0xaf, 0xee, 0xee, 0x80, 0x00, 0x00, 0x00, 0x2f, 0xeb, 0xf0, 0x00, 0x02, 0xea, 0xaa, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x50, 0x00, 0x00, 0x00, 0x15, 0x55, 0x51, 0x00, 0x15, 0x55, 0x55, 0x10, 0x11,
    0xbb, 0xbb, 0xbb, 0xe0, 0x00, 0x00, 0x00, 0x3b, 0xbf, 0x00, 0x00, 0x03, 0xae, 0xba, 0x00, 0x00,
    0x55, 0x55, 0x55, 0xd0, 0x00, 0x00, 0x00, 0x15, 0xd5, 0x44, 0x00, 0x01, 0x55, 0x54, 0x40, 0x00,
    0xaa, 0xee, 0xef, 0xe0, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xe0, 0x00, 0x00, 0x08, 0xe8, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x70, 0x00, 0x00, 0x00, 0x11, 0x77, 0x51, 0x11, 0x10, 0x15, 0x55, 0x00, 0x01,
    0xaa, 0xbb, 0xbb, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xbf, 0xb8, 0x00, 0x00, 0x0f, 0xb8, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x55, 0x74, 0x00, 0x40, 0x05, 0x54, 0x00, 0x00,
    0xae, 0xfe, 0xef, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x62, 0xfc, 0x00, 0x00, 0x00, 0xac, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x75, 0x50, 0x00, 0x01, 0x11, 0x55, 0x77, 0x11, 0x10, 0x01, 0x54, 0x00, 0x01,
    0xab, 0xbb, 0xbb, 0xff, 0xa0, 0x00, 0x00, 0x00, 0x03, 0xff, 0x80, 0x00, 0x00, 0x2a, 0x00, 0x00,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x50, 0x04, 0x44, 0x15, 0x55, 0x40, 0x00, 0x01, 0x41, 0x40, 0x01,
    0xaf, 0xee, 0xea, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x00, 0x00, 0xcf, 0xaa, 0xe0,
    0x15, 0x55, 0x55, 0x77, 0x75, 0x00, 0x01, 0x11, 0x55, 0x55, 0x50, 0x11, 0x11, 0x55, 0x75, 0x51,
    0x00, 0x00, 0x00, 0xff, 0xf8, 0x02, 0x00, 0x00, 0x3b, 0xfa, 0x00, 0x00, 0x00, 0xaa, 0x3f, 0xf0,
    0x54, 0x55, 0x50, 0x55, 0x50, 0x50, 0x00, 0x01, 0x55, 0x55, 0x50, 0x44, 0x40, 0x55, 0x55, 0x40,
    0x00, 0x80, 0x28, 0xff, 0xe0, 0x00, 0x00, 0x03, 0x8e, 0xea, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00,
    0x55, 0x57, 0x55, 0x55, 0x50, 0x00, 0x00, 0x15, 0x55, 0x55, 0x11, 0x10, 0x10, 0x55, 0x55, 0x51,
    0x20, 0x00, 0x3f, 0xbb, 0xa0, 0x00, 0x00, 0x00, 0xaa, 0xa2, 0x02, 0x00, 0x00, 0x22, 0x20, 0x2a,
    0x54, 0x45, 0x55, 0x55, 0x40, 0x00, 0x00, 0x55, 0x55, 0x55, 0x45, 0x00, 0x05, 0x55, 0x15, 0x55,
    0x80, 0x00, 0x2e, 0xab, 0x80, 0x00, 0x00, 0x00, 0xa8, 0x80, 0x00, 0x00, 0x00, 0xae, 0x20, 0xfe};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1040)

void setup()
{
    // Initialize serial communication
    Serial.begin(115200);

    // Initialize the DHT sensor
    dht.setup(DHTPIN, DHTTYPE);

    // Initialize the button pin
    pinMode(BUTTON_PIN, INPUT_PULLUP);

    // Initialize the LED pins
    pinMode(RED_LED_PIN, OUTPUT);
    pinMode(GREEN_LED_PIN, OUTPUT);

    // Create a binary semaphore for the button press
    buttonSemaphore = xSemaphoreCreateBinary();

    // Initialize the display
    display.begin(SSD1306_SWITCHCAPVCC, 0x3C);


    display.clearDisplay();
    display.setCursor(0, 0);
    // delay(1000);
    display.drawBitmap(0, 0, bitmap, 128, 64, WHITE);
    display.display();
    delay(3000);
    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(WHITE);
    display.setCursor(0, 0);

    // Connect to Wi-Fi
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED)
    {
        delay(1000);
        Serial.println("Connecting to WiFi...");
    }

    // Set the timezone and fetch NTP time
    configTime(UTC_OFFSET * 3600, UTC_OFFSET_DST * 3600, NTP_SERVER);
    Serial.println("Fetching NTP time...");
    while (time(nullptr) < 100000)
    {
        delay(1000);
    }
    Serial.println("NTP time updated.");

    // Create tasks
    xTaskCreate(temperatureTask, "TemperatureTask", 10000, NULL, 1, &temperatureTaskHandle);
    xTaskCreate(displayTask, "DisplayTask", 10000, NULL, 1, &displayTaskHandle);
}

void loop()
{
    // Check if the button is pressed
    if (digitalRead(BUTTON_PIN) == LOW)
    {
        // Take the semaphore to signal button press
        Serial.println("Button pressed");
        xSemaphoreGive(buttonSemaphore);
    }

    delay(10);
}

void temperatureTask(void *parameter)
{
    for (;;)
    {
        data = dht.getTempAndHumidity();

        // Toggle the LED states
        redLedState = !redLedState;
        greenLedState = !greenLedState;

        // Update the LED states
        digitalWrite(RED_LED_PIN, redLedState ? HIGH : LOW);
        digitalWrite(GREEN_LED_PIN, greenLedState ? HIGH : LOW);

        vTaskDelay(pdMS_TO_TICKS(2000));
    }
}

void displayTask(void *parameter)
{
    for (;;)
    {
        // Check if the button is pressed
        if (xSemaphoreTake(buttonSemaphore, 0) == pdTRUE)
        {
            // Switch to displaying the clock
            currentDisplayMode = DISPLAY_MODE_CLOCK;
        }
        else{
            currentDisplayMode = DISPLAY_MODE_TEMP_HUM;
        }

        if (currentDisplayMode == DISPLAY_MODE_TEMP_HUM)
        {
            // Display temperature and humidity
            display.clearDisplay();
            display.setCursor(0, 0);
            display.print("Temp: ");
            display.print(data.temperature);
            display.print("C");
            display.setCursor(0, 32);
            display.print("Humidity: ");
            display.print(data.humidity);
            display.print("%");
            display.display();
        }
        else if (currentDisplayMode == DISPLAY_MODE_CLOCK)
        {
            time_t currentTime = time(nullptr);
            struct tm *timeInfo = localtime(&currentTime);
            int start = timeInfo->tm_sec;
            while(timeInfo->tm_sec - start < time_to_display_clock){
                display.clearDisplay();
                display.setCursor(0, 0);
                display.print("Time: ");
                display.setCursor(0, 20);
                display.print(timeInfo->tm_hour);
                display.print(":");
                display.print(timeInfo->tm_min);
                display.print(":");
                display.print(timeInfo->tm_sec);
                display.display();
                currentTime = time(nullptr);
                timeInfo = localtime(&currentTime);
                Serial.println(timeInfo->tm_sec-start);
            }
            // xSemaphoreGive(buttonSemaphore);
        }

        // vTaskDelay(pdMS_TO_TICKS(1000));

        // Other display tasks or data updates

        vTaskDelay(pdMS_TO_TICKS(200));
    }
}
